<!DOCTYPE html>
<html>
<head>
    <title>Test Contained Map - Fix Positioning</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <!-- Ultra-simple map styling - fix positioning issues -->
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f3f4f6; }
        
        /* Simulate Laravel layout */
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .tab-container { margin: 20px 0; border-bottom: 1px solid #e5e7eb; }
        .tab-button { 
            padding: 12px 16px; 
            margin-right: 8px; 
            border: none; 
            background: none; 
            cursor: pointer; 
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
        .tab-button.active { 
            color: #3b82f6; 
            border-bottom-color: #3b82f6;
        }
        .tab-content { 
            display: none; 
            padding: 24px 0; 
        }
        .tab-content:not(.hidden) { 
            display: block; 
        }
        .hidden { display: none !important; }
        
        /* Force map container to be contained within its parent */
        #map {
            height: 400px !important;
            width: 100% !important;
            position: relative !important;
            z-index: 1 !important;
            background: #f9fafb !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 8px !important;
            /* CRITICAL: Prevent map from escaping container */
            max-width: 100% !important;
            overflow: hidden !important;
            box-sizing: border-box !important;
        }
        
        /* Ensure Leaflet container stays within bounds */
        .leaflet-container {
            height: 400px !important;
            width: 100% !important;
            font-family: inherit !important;
            /* CRITICAL: Prevent overflow */
            max-width: 100% !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        /* Fix leaflet controls positioning */
        .leaflet-control-container {
            position: relative !important;
            z-index: 2 !important;
        }
        
        /* Ensure tiles stay within container */
        .leaflet-tile {
            max-width: none !important;
        }
        
        /* Fix popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 8px !important;
        }
        
        /* CRITICAL: Ensure tab content contains the map properly */
        #content-location {
            position: relative !important;
            overflow: hidden !important;
            max-width: 100% !important;
        }
        
        /* Ensure map parent container is properly sized */
        .mb-6 {
            position: relative !important;
            overflow: hidden !important;
        }
        
        .info { margin: 10px 0; padding: 10px; background: #f0f9ff; border-radius: 4px; }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è Test Contained Map - Fix Positioning</h1>
        <p>This tests that the map stays within its container and doesn't overflow to cover other content.</p>
        
        <!-- Content above map -->
        <div style="background: #e5e7eb; padding: 20px; margin: 20px 0; border-radius: 8px;">
            <h3>Content Above Map</h3>
            <p>This content should remain visible and not be covered by the map.</p>
        </div>
        
        <!-- Tab simulation - exact same structure as Laravel -->
        <div class="tab-container">
            <button id="tab-patroli" class="tab-button active">
                Riwayat Patroli
            </button>
            <button id="tab-location" class="tab-button">
                Verifikasi Lokasi
            </button>
        </div>
        
        <!-- Tab Contents -->
        <div id="content-patroli" class="tab-content">
            <h3>Riwayat Patroli</h3>
            <p>This is the patrol history tab content. The map should not cover this when location tab is active.</p>
        </div>
        
        <div id="content-location" class="tab-content hidden">
            <h3>Verifikasi Lokasi</h3>
            
            <!-- Maps Container -->
            <div class="mb-6">
                <h4 style="font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 16px;">Peta Lokasi Checkpoint</h4>
                
                <!-- Map container - no inline styles -->
                <div id="map"></div>
                
                <div id="map-status" style="margin-top: 8px; font-size: 14px; color: #6b7280;">
                    <span id="map-loading">
                        Loading map...
                    </span>
                </div>
            </div>
            
            <!-- Content below map -->
            <div style="background: #f3f4f6; padding: 20px; margin-top: 20px; border-radius: 8px;">
                <h4>Location Statistics</h4>
                <p>This content should be visible below the map, not covered by it.</p>
            </div>
        </div>
        
        <!-- Content below tabs -->
        <div style="background: #fef3c7; padding: 20px; margin: 20px 0; border-radius: 8px;">
            <h3>Content Below Tabs</h3>
            <p>This content should always remain visible and not be covered by the map.</p>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>

    <script>
        // Tab switching function
        function showTab(tabName) {
            console.log('showTab called with:', tabName);
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedContent = document.getElementById('content-' + tabName);
            if (selectedContent) {
                selectedContent.classList.remove('hidden');
            }
            
            // Add active class to selected tab button
            const selectedButton = document.getElementById('tab-' + tabName);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
            
            // Initialize map if location tab is selected
            if (tabName === 'location') {
                setTimeout(function() {
                    if (!window.map) {
                        initContainedMap();
                    } else {
                        window.map.invalidateSize();
                    }
                }, 200);
            }
        }
        
        // Map implementation with proper containment
        let map;
        let markers = [];

        // Fix Leaflet marker icons issue - use CDN icons
        delete L.Icon.Default.prototype._getIconUrl;
        L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',
            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        });

        function initContainedMap() {
            try {
                console.log('üó∫Ô∏è Starting contained map initialization...');
                
                // Update status
                const statusElement = document.getElementById('map-loading');
                if (statusElement) {
                    statusElement.innerHTML = '<span style="color: #3b82f6;">Initializing contained map...</span>';
                }
                
                // Check if map element exists and has dimensions
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error('‚ùå Map element not found');
                    return;
                }
                
                console.log('‚úÖ Map element found, dimensions:', mapElement.offsetWidth, 'x', mapElement.offsetHeight);
                console.log('üîç Map element parent:', mapElement.parentElement);
                console.log('üîç Map element computed styles:', {
                    position: window.getComputedStyle(mapElement).position,
                    zIndex: window.getComputedStyle(mapElement).zIndex,
                    overflow: window.getComputedStyle(mapElement).overflow,
                    maxWidth: window.getComputedStyle(mapElement).maxWidth
                });
                
                // Initialize map
                map = L.map('map').setView([-6.2088, 106.8456], 15);
                window.map = map; // Make it global for tab switching
                
                console.log('‚úÖ Leaflet map object created');
                
                // Add OpenStreetMap tiles
                const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18,
                    minZoom: 1
                });
                
                let tilesLoaded = 0;
                
                tileLayer.on('tileload', function() {
                    tilesLoaded++;
                    if (tilesLoaded === 1) {
                        console.log('‚úÖ First tile loaded successfully');
                        if (statusElement) {
                            statusElement.innerHTML = '<span style="color: #10b981;">‚úÖ Contained map loaded successfully</span>';
                        }
                    }
                });
                
                tileLayer.on('tileerror', function(e) {
                    console.warn('‚ö†Ô∏è Tile error:', e);
                });
                
                tileLayer.addTo(map);
                console.log('‚úÖ Tile layer added');
                
                // Add test markers
                setTimeout(function() {
                    addTestMarkers();
                }, 500);
                
                // Force map to resize and stay contained
                setTimeout(function() {
                    if (map) {
                        map.invalidateSize();
                        console.log('‚úÖ Map size invalidated and contained');
                    }
                }, 1000);
                
                console.log('‚úÖ Contained map initialization complete');
                
            } catch (error) {
                console.error('‚ùå Error in contained map initialization:', error);
                const statusElement = document.getElementById('map-loading');
                if (statusElement) {
                    statusElement.innerHTML = '<span style="color: #ef4444;">‚ùå Map failed to load: ' + error.message + '</span>';
                }
            }
        }

        function addTestMarkers() {
            console.log('üìç Adding test markers...');
            
            try {
                // Add checkpoint markers
                const checkpointMarker1 = L.marker([-6.2088, 106.8456])
                    .addTo(map)
                    .bindPopup('<b>Checkpoint Alpha</b><br>QR001<br><small>Checkpoint Terdaftar</small>');
                markers.push(checkpointMarker1);
                
                const checkpointMarker2 = L.marker([-6.2100, 106.8470])
                    .addTo(map)
                    .bindPopup('<b>Checkpoint Beta</b><br>QR002<br><small>Checkpoint Terdaftar</small>');
                markers.push(checkpointMarker2);
                
                // Add patrol markers
                const patrolMarker1 = L.marker([-6.2090, 106.8458])
                    .addTo(map)
                    .bindPopup('<b>Patrol Location</b><br>18 Jan 2026 14:30<br><small>Lokasi Patroli</small>');
                markers.push(patrolMarker1);
                
                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                    console.log('üéØ Map bounds adjusted for', markers.length, 'markers');
                }
                
                console.log('‚úÖ All test markers added successfully');
                
            } catch (error) {
                console.error('‚ùå Error adding markers:', error);
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåê DOM loaded for contained map test');
            
            // Add click listeners to tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabName = this.id.replace('tab-', '');
                    showTab(tabName);
                });
            });
            
            console.log('‚úÖ Tab system initialized');
        });
    </script>
</body>
</html>
</content>