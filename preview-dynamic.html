<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Preview Lokasi Dinamis - Adonara Maps</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { height: 100vh }
    .info {
      position:absolute;
      bottom:10px;
      left:10px;
      background:#fff;
      padding:10px 14px;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.2);
      font-size:13px;
      max-width: 300px;
    }
    .status {
      position:absolute;
      top:10px;
      right:10px;
      background:#fff;
      padding:8px 12px;
      border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      font-size:12px;
    }
    .success { color: #059669; }
    .error { color: #dc2626; }
    .loading { color: #2563eb; }
    .controls {
      position:absolute;
      top:10px;
      left:10px;
      background:#fff;
      padding:10px;
      border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      font-size:12px;
    }
  </style>
</head>
<body>

<div id="map"></div>
<div class="status">
  <span id="status-text" class="loading">Loading...</span>
</div>
<div class="controls">
  <div><strong>URL Parameters:</strong></div>
  <div id="params-info">Loading...</div>
</div>
<div class="info">
  <div id="location-info">Loading location...</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  function updateStatus(message, type = 'loading') {
    const statusEl = document.getElementById('status-text');
    statusEl.textContent = message;
    statusEl.className = type;
  }
  
  function updateLocationInfo(message) {
    document.getElementById('location-info').innerHTML = message;
  }
  
  function updateParamsInfo(lat, lon) {
    document.getElementById('params-info').innerHTML = `
      Lat: ${lat}<br>
      Lon: ${lon}
    `;
  }

  // Get parameters from URL - exactly like your example
  const params = new URLSearchParams(window.location.search);
  const lat = parseFloat(params.get('lat')) || -6.2088; // Default Jakarta
  const lon = parseFloat(params.get('lon')) || 106.8456;
  
  updateParamsInfo(lat, lon);
  
  // Initialize map
  const map = L.map('map').setView([lat, lon], 17);

  // Adonara Maps tiles - correct URL format
  const tileLayer = L.tileLayer('https://maps.adonara.co.id/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: 'Â© Adonara Maps'
  });
  
  let tilesLoaded = 0;
  let tilesErrored = 0;
  
  tileLayer.on('tileload', function() {
    tilesLoaded++;
    if (tilesLoaded === 1) {
      updateStatus('âœ… Adonara Maps loaded!', 'success');
    }
  });
  
  tileLayer.on('tileerror', function(e) {
    tilesErrored++;
    console.error('Tile error:', e);
    if (tilesErrored > 3) {
      updateStatus('âŒ Maps failed to load', 'error');
      // Fallback to OpenStreetMap
      map.removeLayer(tileLayer);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
      updateStatus('ðŸ”„ Using OpenStreetMap fallback', 'loading');
    }
  });
  
  tileLayer.addTo(map);

  // Fetch reverse geocoding and add marker - exactly like your example
  fetch(`https://maps.adonara.co.id/reverse?lat=${lat}&lon=${lon}&format=json`)
    .then(res => res.json())
    .then(data => {
      console.log('Reverse geocoding result:', data);
      
      // Add marker with popup
      L.marker([lat, lon]).addTo(map)
        .bindPopup(`
          <b>Lokasi</b><br>
          ${data.display_name || 'Unknown location'}<br>
          <small>Koordinat: ${lat}, ${lon}</small>
        `)
        .openPopup();
        
      // Update info panel
      updateLocationInfo(`
        <b>Alamat</b><br>
        ${data.display_name || 'Unknown location'}<br>
        <small>Koordinat: ${lat}, ${lon}</small>
      `);
      
      // Add bounding box if available
      if (data.boundingbox && data.boundingbox.length === 4) {
        const bounds = [
          [parseFloat(data.boundingbox[0]), parseFloat(data.boundingbox[2])],
          [parseFloat(data.boundingbox[1]), parseFloat(data.boundingbox[3])]
        ];
        
        L.rectangle(bounds, {
          color: "#3388ff",
          weight: 1,
          fillOpacity: 0.1
        }).addTo(map);
      }
      
    })
    .catch(err => {
      console.error('Reverse geocoding error:', err);
      
      // Add marker without reverse geocoding
      L.marker([lat, lon]).addTo(map)
        .bindPopup(`
          <b>Lokasi</b><br>
          Koordinat: ${lat}, ${lon}
        `)
        .openPopup();
        
      updateLocationInfo(`
        <b>Lokasi</b><br>
        Koordinat: ${lat}, ${lon}<br>
        <small>Reverse geocoding tidak tersedia</small>
      `);
    });
</script>

</body>
</html>