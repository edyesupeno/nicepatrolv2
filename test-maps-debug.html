<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Maps - Leaflet JS</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #map { 
            height: 400px; 
            width: 100%; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            background-color: #f9fafb;
        }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .status.error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .status.warning { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .log { background: #f3f4f6; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
        button { padding: 8px 16px; margin: 5px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1d4ed8; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .info-item { background: #f8fafc; padding: 10px; border-radius: 4px; border-left: 4px solid #2563eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è Debug Maps - Leaflet JS</h1>
        
        <div class="card">
            <h3>Status Koneksi</h3>
            <div id="status" class="status">Checking...</div>
            
            <div class="info-grid">
                <div class="info-item">
                    <strong>Tile Server Primary:</strong><br>
                    <span id="primary-server">https://maps.adonara.co.id/</span>
                </div>
                <div class="info-item">
                    <strong>Tile Server Fallback:</strong><br>
                    <span>OpenStreetMap</span>
                </div>
                <div class="info-item">
                    <strong>Leaflet Version:</strong><br>
                    <span id="leaflet-version">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Map Status:</strong><br>
                    <span id="map-status">Initializing...</span>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>Peta Interaktif</h3>
            <div class="controls">
                <button onclick="testPrimaryServer()">Test Primary Server</button>
                <button onclick="testFallbackServer()">Test Fallback Server</button>
                <button onclick="addTestMarkers()">Add Test Markers</button>
                <button onclick="clearMap()">Clear Map</button>
                <button onclick="goToJakarta()">Jakarta</button>
                <button onclick="goToBandung()">Bandung</button>
            </div>
            <div id="map"></div>
        </div>
        
        <div class="card">
            <h3>Debug Log</h3>
            <div id="log" class="log"></div>
            <button onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>

    <script>
        let map;
        let markers = [];
        let currentTileLayer = null;
        
        // Configuration
        const config = {
            primary: {
                url: 'https://maps.adonara.co.id/tile/{z}/{x}/{y}.png',
                attribution: '¬© <a href="https://maps.adonara.co.id/">Adonara Maps</a>',
                name: 'Adonara Maps'
            },
            fallback: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '¬© OpenStreetMap contributors',
                name: 'OpenStreetMap'
            },
            center: [-6.2088, 106.8456],
            zoom: 12
        };
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#6b7280';
            logDiv.innerHTML += `<div style="color: ${color};">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function updateMapStatus(message) {
            document.getElementById('map-status').textContent = message;
        }
        
        // Initialize map
        function initMap() {
            try {
                log('üöÄ Initializing Leaflet Map...', 'info');
                updateMapStatus('Initializing...');
                
                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet library not loaded');
                }
                
                document.getElementById('leaflet-version').textContent = L.version;
                log(`üì¶ Leaflet version: ${L.version}`, 'success');
                
                // Initialize map
                map = L.map('map').setView(config.center, config.zoom);
                log('üó∫Ô∏è Map container initialized', 'success');
                
                // Test primary server first
                testPrimaryServer();
                
                updateMapStatus('Ready');
                log('‚úÖ Map initialization complete', 'success');
                
            } catch (error) {
                log(`‚ùå Error initializing map: ${error.message}`, 'error');
                updateStatus(`Initialization failed: ${error.message}`, 'error');
                updateMapStatus('Failed');
            }
        }
        
        function testPrimaryServer() {
            log('üîç Testing primary server (Adonara Maps)...', 'info');
            
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            currentTileLayer = L.tileLayer(config.primary.url, {
                attribution: config.primary.attribution,
                maxZoom: 18,
                minZoom: 1,
                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
            });
            
            let tileLoadCount = 0;
            let tileErrorCount = 0;
            
            currentTileLayer.on('tileload', function(e) {
                tileLoadCount++;
                if (tileLoadCount === 1) {
                    log(`‚úÖ Primary server working! First tile loaded from: ${config.primary.name}`, 'success');
                    updateStatus(`Primary server (${config.primary.name}) is working correctly`, 'success');
                }
            });
            
            currentTileLayer.on('tileerror', function(e) {
                tileErrorCount++;
                log(`‚ö†Ô∏è Tile error from primary server: ${e.error || 'Unknown error'}`, 'error');
                
                if (tileErrorCount >= 3) {
                    log('üîÑ Too many errors, switching to fallback server...', 'warning');
                    updateStatus('Primary server failed, switching to fallback', 'warning');
                    testFallbackServer();
                }
            });
            
            currentTileLayer.on('loading', function() {
                log('‚è≥ Loading tiles from primary server...', 'info');
                updateStatus('Loading tiles from primary server...', 'info');
            });
            
            currentTileLayer.addTo(map);
        }
        
        function testFallbackServer() {
            log('üîÑ Switching to fallback server (OpenStreetMap)...', 'info');
            
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            currentTileLayer = L.tileLayer(config.fallback.url, {
                attribution: config.fallback.attribution,
                maxZoom: 19,
                minZoom: 1
            });
            
            currentTileLayer.on('tileload', function(e) {
                log(`‚úÖ Fallback server working! Tiles loaded from: ${config.fallback.name}`, 'success');
                updateStatus(`Using fallback server (${config.fallback.name})`, 'warning');
            });
            
            currentTileLayer.on('tileerror', function(e) {
                log(`‚ùå Fallback server also failed: ${e.error || 'Unknown error'}`, 'error');
                updateStatus('Both servers failed - check internet connection', 'error');
            });
            
            currentTileLayer.addTo(map);
        }
        
        function addTestMarkers() {
            log('üìç Adding test markers...', 'info');
            
            const testLocations = [
                { name: 'Jakarta', lat: -6.2088, lng: 106.8456, color: '#2563eb' },
                { name: 'Bandung', lat: -6.9175, lng: 107.6191, color: '#10b981' },
                { name: 'Surabaya', lat: -7.2575, lng: 112.7521, color: '#ef4444' }
            ];
            
            testLocations.forEach(location => {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: ${location.color}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                const marker = L.marker([location.lat, location.lng], { icon: icon }).addTo(map);
                
                marker.bindPopup(`
                    <div style="padding: 10px;">
                        <h3 style="margin: 0 0 8px 0; color: ${location.color};">${location.name}</h3>
                        <p style="margin: 0; font-size: 12px;">
                            <strong>Koordinat:</strong><br>
                            ${location.lat}, ${location.lng}
                        </p>
                    </div>
                `);
                
                markers.push(marker);
                log(`üìç Added marker for ${location.name}`, 'success');
            });
            
            // Fit map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
                log('üéØ Map bounds adjusted to show all markers', 'success');
            }
        }
        
        function clearMap() {
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];
            log('üßπ All markers cleared', 'info');
        }
        
        function goToJakarta() {
            map.setView([-6.2088, 106.8456], 12);
            log('üèôÔ∏è Navigated to Jakarta', 'info');
        }
        
        function goToBandung() {
            map.setView([-6.9175, 107.6191], 12);
            log('üèîÔ∏è Navigated to Bandung', 'info');
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            log('üåê DOM loaded, starting map initialization...', 'info');
            setTimeout(initMap, 100);
        });
    </script>
</body>
</html>